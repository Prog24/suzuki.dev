{"pageProps":{"frontmatter":{"title":"ConoHaのAPIに触れてみた","date":"2017-12-07T10:00:00.000Z","template":"post","draft":false,"slug":"ConoHa-API","category":"Web勉強","tags":["API","ConoHa","PHP"],"description":"ConoHaのAPIに触れてみた"},"markdownBody":"\nConoHaのAPIに触れたいな。とふと思いPHPで触ったのでそれのメモ。。  \n\nまず最初にAPIを使用するためのトークンを取得する必要があるとのことで、トークン発行[公式DOC]を見て下記のコードを作成。  \n\nユーザ名、パスワード、テナントIDはConoHaのコントロールパネルで確認して変数にした。  \n\nトークン取得\n```php\n<?php\n/**\n * トークン取得\n */\nfunction getToken($username, $password, $tenantId)\n{\n\n    $url = \"https://identity.tyo1.conoha.io/v2.0/tokens\";\n    \n    $headers = array(\n        \"Accept: application/json\"\n    );\n\n    $req_data = array(\n        \"auth\" => array(\n            \"passwordCredentials\" => array(\n                \"username\" => $username,\n                \"password\" => $password\n            ),\n            \"tenantId\" => $tenantId\n        )\n    );\n\n    $curl = curl_init();\n    curl_setopt($curl, CURLOPT_URL, $url);\n    curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\n    curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);\n    curl_setopt($curl, CURLOPT_POST, true);\n    curl_setopt($curl, CURLOPT_POSTFIELDS, json_encode($req_data));\n    curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);\n    $res_json =  curl_exec($curl);\n    $res_data = json_decode($res_json);\n    curl_close($curl);\n    \n    return $res_data;\n}\n```\n\n今回は取り敢えずとして[請求データ一覧取得-公式DOC](https://www.conoha.jp/docs/account-billing-invoices-list.html)を実装しようと思う。  \n\nトークンとテナントIDを使用して取得した。  \n\n支払い情報一覧取得\n```php\n<?php\n/**\n * 請求データ一覧取得\n */\nfunction getPayList($token, $tenantId)\n{\n    $url = \"https://account.tyo1.conoha.io/v1/{$tenantId}/billing-invoices?limit=3\";\n    $headers = array(\n        \"Accept: application/json\",\n        \"X-Auth-Token: {$token}\"\n    );\n    \n    $curl = curl_init();\n    curl_setopt($curl, CURLOPT_URL, $url);\n    curl_setopt($curl, CURLOPT_CUSTOMREQUEST, 'GET');\n    curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);\n    curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);\n    curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\n    $response = curl_exec($curl);\n    \n    return $response;\n}\n```\n\n上記のコードで取得できるデータは直近3回分の支払い情報なのでjson_decodeで配列に直し、最新のデータから支払い金額だけを取得して表示するようにした。\n最新の支払い金額取得\n```php\n<?php\n/**\n * 最新の支払い金額を表示する\n*/\n// トークン取得\n$tokens = getToken($username, $password, $tenantId);\n$token  = $tokens->access->token->id;\n// 支払い情報一覧取得\n$pays   = getPayList($token, $tenantId);\n$array  = json_decode($pays);\n// 一番最近の支払い金額を表示\nprint_r($array->billing_invoices[0]->bill_plus_tax);\n```\n"},"__N_SSG":true}